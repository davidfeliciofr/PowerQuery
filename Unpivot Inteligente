# 05PQ - ğŸ”„ Unpivot Inteligente | TransformaÃ§Ã£o DinÃ¢mica no Power Query

## David Felicio  
Analista de Dados | Power BI | Power Query | DAX | AnÃ¡lise de Dados | VisualizaÃ§Ã£o de Dados | Data Visualizations | Data Analytics | Python | SQL | Business Intelligence

**7 de marÃ§o de 2025**  

No Power Query, um dos desafios mais comuns Ã© transformar dados de forma dinÃ¢mica, sem precisar ajustar manualmente sempre que novas colunas surgem. Neste artigo, vamos explorar uma abordagem avanÃ§ada para fazer Unpivot dinÃ¢mico, garantindo que nossa soluÃ§Ã£o seja flexÃ­vel e se adapte automaticamente a mudanÃ§as na estrutura da tabela.

## ğŸš€ CenÃ¡rio do Problema
Imagine que vocÃª recebe um arquivo Excel regularmente com dados estruturados como no exemplo abaixo:

A cada mÃªs, novas colunas aparecem com os valores mensais de cada funcionÃ¡rio.  
Se fizermos um Unpivot manual, precisarÃ­amos sempre selecionar as colunas que representam os meses, o que tornaria o processo rÃ­gido e pouco eficiente.

**Nosso objetivo:** Criar uma soluÃ§Ã£o dinÃ¢mica para detectar e desmembrar apenas as colunas de datas, deixando as demais intactas.

Antes de comeÃ§ar o passo a passo, entenda como funciona a funÃ§Ã£o `Table.UnpivotOtherColumns` no Power Query (M): ela Ã© usada para transformar colunas de uma tabela de um formato largo para um formato longo (*tidy data*).  

Ela permite especificar quais colunas devem ser mantidas, enquanto todas as outras sÃ£o desmembradas em um formato de chave-valor.

### ğŸ“Œ Sintaxe da funÃ§Ã£o
```m
Table.UnpivotOtherColumns(tabela, colunasManter, nomeNovaColunaAtributo, nomeNovaColunaValor)
```

### ğŸ“– ParÃ¢metros
1. **tabela** â†’ A tabela que queremos transformar.  
2. **colunasManter** â†’ Uma lista das colunas que **NÃƒO** serÃ£o desmembradas (exemplo: IDs ou categorias fixas).  
3. **nomeNovaColunaAtributo** â†’ O nome da nova coluna que conterÃ¡ os nomes das colunas desmembradas.  
4. **nomeNovaColunaValor** â†’ O nome da nova coluna que conterÃ¡ os valores correspondentes.

## ğŸ¯ Exemplo prÃ¡tico

### ğŸ“Š Tabela Original

Agora, aplicamos:
```m
Table.UnpivotOtherColumns(TabelaOriginal, {"ID", "Nome"}, "MÃªs", "Valor")
```

### ğŸ“ Resultado apÃ³s o Unpivot

## ğŸ” Passo a Passo da SoluÃ§Ã£o
Abaixo, detalhamos a query utilizada para realizar essa transformaÃ§Ã£o de forma automÃ¡tica:

```m
let
    // 1ï¸âƒ£ ImportaÃ§Ã£o do arquivo Excel
    Fonte = Excel.Workbook(File.Contents("C:\\Users\\pasta\\arquivo.xlsx"), null, true),
    Tabela1_Table = Fonte{[Item="Tabela1",Kind="Table"]}[Data],

    // 2ï¸âƒ£ Capturar os nomes das colunas
    NomesDasColunas = Table.ColumnNames(Tabela1_Table),

    // 3ï¸âƒ£ Identificar dinamicamente quais colunas NÃƒO sÃ£o datas
    ListaDeNomes = 
        List.Select(
            NomesDasColunas,
            each not (try Date.From(Text.From(_)) is date otherwise false)
        ),

    // 4ï¸âƒ£ Realizar Unpivot das colunas dinÃ¢micas
    #"Outras Colunas NÃ£o DinÃ¢micas" = Table.UnpivotOtherColumns(Tabela1_Table, ListaDeNomes, "Atributo", "Valor")
    
    in
    #"Outras Colunas NÃ£o DinÃ¢micas"
```

## ğŸ›  ExplicaÃ§Ã£o da Query

### ğŸ”¹ 2. Capturar os nomes das colunas
```m
NomesDasColunas = Table.ColumnNames(Tabela1_Table),
```
ExtraÃ­mos uma lista contendo os nomes das colunas presentes na tabela.

**Exemplo do conteÃºdo de `NomesDasColunas`:**
```m
{"ID", "Nome", "01/2024", "02/2024", "03/2024"}
```

### ğŸ”¹ 3. Identificar dinamicamente quais colunas NÃƒO sÃ£o datas
```m
ListaDeNomes = List.Select(
    NomesDasColunas,
    each not (try Date.From(Text.From(_)) is date otherwise false)
),
```
Aqui acontece a mÃ¡gica da automatizaÃ§Ã£o! âœ¨

- `try Date.From(Text.From(_)) is date otherwise false`  
  - Converte o nome da coluna para texto e tenta transformÃ¡-lo em data.
  - Se for uma data vÃ¡lida, retorna `true`.
  - Se nÃ£o for uma data, retorna `false`.
- `List.Select(..., each not (...))`  
  - Mantemos apenas os nomes das colunas que **nÃ£o** sÃ£o datas, como "ID" e "Nome".

**Exemplo do resultado de `ListaDeNomes`:**
```m
{"ID", "Nome"}
```
Agora temos apenas os nomes das colunas que nÃ£o precisam de Unpivot, para usarmos no prÃ³ximo passo.

### ğŸ”¹ 4. Realizar Unpivot das colunas dinÃ¢micas
```m
#"Outras Colunas NÃ£o DinÃ¢micas" = Table.UnpivotOtherColumns(Tabela1_Table, ListaDeNomes, "Atributo", "Valor"),
```

Agora os valores mensais foram reorganizados em uma estrutura *tidy data*, facilitando anÃ¡lises dinÃ¢micas no Power BI.

## ğŸ¯ BenefÃ­cios dessa Abordagem
âœ… **Totalmente dinÃ¢mica** â€“ adapta-se automaticamente a novas colunas adicionadas ao Excel.  
âœ… **Evita manutenÃ§Ã£o manual** â€“ elimina ajustes manuais constantes.  
âœ… **Melhora a escalabilidade** â€“ aplicÃ¡vel a diversas bases de dados sem ajustes manuais.  

## ğŸš€ Por que usar `Table.UnpivotOtherColumns`?
âœ… **AutomatizaÃ§Ã£o**: Novas colunas sÃ£o transformadas sem precisar modificar a query.  
âœ… **Flexibilidade**: Perfeito para colunas dinÃ¢micas, como meses ou produtos.  
âœ… **Facilidade de AnÃ¡lise**: Dados no formato longo sÃ£o mais fÃ¡ceis de analisar no Power BI.  

## ğŸ† ConclusÃ£o
Criar Unpivot dinÃ¢mico no Power Query Ã© uma tÃ©cnica poderosa que evita ajustes constantes, tornando a soluÃ§Ã£o escalÃ¡vel e eficiente. ğŸš€

